name: Integration Tests

on:
  workflow_call:
  pull_request:

env:
  BUN_VERSION: 'latest'

jobs:
  integration:
    name: Integration Tests - ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ${{ vars.RUNNER }}
            target: linux-arm64
            artifact: mcp-docsrs-linux-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}
          no-cache: ${{ runner.os == 'Windows' }} # Disable cache on Windows due to issues

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist/

      - name: Make executable
        if: matrix.os != 'windows-latest'
        run: chmod +x dist/${{ matrix.artifact }}

      - name: Run integration tests
        if: matrix.needs-docker != true
        shell: bash
        run: |
          # Set executable name based on platform
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            EXECUTABLE="./dist/${{ matrix.artifact }}.exe"
          else
            EXECUTABLE="./dist/${{ matrix.artifact }}"
          fi

          # Run integration test suite
          FLAGS=""
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            FLAGS="$FLAGS --windows"
          fi

          bun test/integration/test-binary.ts "$EXECUTABLE" "${{ matrix.target }}" $FLAGS
